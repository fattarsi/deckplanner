<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Deck Detail</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
  .card-column {
    width: 180px;
    position: relative;
  }
  .card-column img {
    width: 100%;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,.1);
    margin-top: -220px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    z-index: 0;
  }
  .card-column img:first-child {
    margin-top: 0;
  }
  .card-column img:hover ~ img {
    transform: translateY(220px);
  }
  .card-column img:hover {
    z-index: 10;
    transform: scale(1.05);
  }
</style>
</head>
<body class="bg-gray-50 min-h-screen p-6">

<!-- 🏠 Back home -->
<a href="/" class="text-blue-500 hover:underline">&larr; Back home</a>

<h1 class="text-2xl font-bold mb-4" id="deck-name">Loading deck...</h1>

<!-- Supertype columns -->
<div id="columns-container" class="flex flex-wrap gap-8"></div>

<!-- Middle section -->
<div class="mt-8 grid grid-cols-2 gap-8">
  <!-- Remove column -->
  <div>
    <h3 class="text-red-500 font-bold mb-2 text-right">Remove</h3>
    <!-- justify-end will push the contents to the right -->
    <div id="remove-column" class="flex flex-col gap-2 items-end min-h-[100px]" data-list="remove"></div>
  </div>

  <!-- Add column -->
  <div>
    <h3 class="text-green-500 font-bold mb-2">Add</h3>
    <div id="add-column" class="flex flex-col gap-2 min-h-[100px]" data-list="add"></div>
  </div>
</div>
  <button id="commit-changes" class="bg-purple-500 text-white px-3 py-1 rounded mt-4">Commit Changes</button>

<!-- Deck Planner -->
<div class="mt-12">
  <button id="toggle-planner" class="bg-blue-500 text-white px-4 py-2 rounded">Open Deck Planner</button>
  <div id="planner-container" class="mt-4 hidden">
    <div id="planner-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4"></div>
    <!-- Sentinel div to trigger loading next page -->
    <div id="scroll-sentinel" class="h-1"></div>
  </div>
</div>

<script>
  function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]').content;
  }
  new Sortable(document.getElementById('remove-column'), {
    animation: 150,
    group: 'remove',
    draggable: 'img'
  });

  new Sortable(document.getElementById('add-column'), {
    animation: 150,
    group: 'add',
    draggable: 'img'
  });

  function createThumbnail(imgUrl, cardName, list, cardId) {
    const img = document.createElement('img');
    img.src = imgUrl;
    img.title = cardName;
    img.className = 'w-20 h-auto cursor-grab border rounded';
    img.draggable = true;
    img.dataset.list = list;
    img.dataset.id = cardId;
    return img;
  }

  // Handler for clicking a deck card
  document.getElementById('columns-container').addEventListener('click', e => {
    if (e.target.tagName === 'IMG') {
      const card = e.target;
      const cardId = card.dataset.id;
      const removeColumn = document.getElementById('remove-column');

      if (card.classList.contains('border-2')) {
        // Already selected — remove highlight & remove from middle column
        card.classList.remove('border-2', 'border-green-500');

        // Find and remove thumbnail in middle column
        const thumb = removeColumn.querySelector(`img[data-id="${cardId}"]`);
        if (thumb) thumb.remove();
      } else {
        // Highlight this card
        card.classList.add('border-2', 'border-green-500');

        // Create thumbnail in middle column
        const thumb = createThumbnail(card.src, card.title, 'remove', cardId);
        removeColumn.appendChild(thumb);
      }
    }
  });

  // Handler for clicking a planner card
  document.getElementById('planner-grid').addEventListener('click', e => {
    if (e.target.tagName === 'IMG') {
      const card = e.target;
      const cardId = card.dataset.id;
      const addColumn = document.getElementById('add-column');

      if (card.classList.contains('border-2')) {
        // Already selected — remove highlight & thumbnail
        card.classList.remove('border-2', 'border-green-500');
        const thumb = addColumn.querySelector(`img[data-id="${cardId}"]`);
        if (thumb) thumb.remove();
      } else {
        // Highlight
        card.classList.add('border-2', 'border-green-500');

        // Thumbnail
        const thumb = createThumbnail(card.src, card.title, 'add', cardId);
        addColumn.appendChild(thumb);
      }
    }
  });

  document.getElementById('commit-changes').addEventListener('click', async () => {
    const deckId = {{deck_id}}; // pass this in context or as a data-attr
    const addIds = Array.from(document.getElementById('add-column').children).map(img => img.dataset.id);
    const removeIds = Array.from(document.getElementById('remove-column').children).map(img => img.dataset.id);

    const resp = await fetch(`/api/decks/${deckId}/update_cards/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({ add_ids: addIds, remove_ids: removeIds })
    });

    if (resp.ok) {
      alert('Changes committed successfully.');
      location.reload();
    } else {
      const err = await resp.json();
      alert(`Error: ${JSON.stringify(err)}`);
    }
  });


  const deckId = "{{ deck_id }}";
  async function loadDeck() {
    const resp = await fetch(`/api/decks/${deckId}/`);
    const data = await resp.json();
    document.getElementById('deck-name').textContent = data.name;

    const grouped = {};
    data.cards.forEach(card => {
      const supertype = card.oracle_card.type_line.split(' —')[0];
      if (!grouped[supertype]) grouped[supertype] = [];
      grouped[supertype].push(card);
    });

    const container = document.getElementById('columns-container');

    for (const [typeLine, cards] of Object.entries(grouped)) {
      const columnDiv = document.createElement('div');

      const title = document.createElement('h2');
      title.textContent = typeLine;
      title.className = 'font-semibold text-lg mb-2';
      columnDiv.appendChild(title);

      const column = document.createElement('div');
      column.className = 'card-column';
      columnDiv.appendChild(column);

      const imgUrls = await Promise.all(
        cards.map(async (c) => {
          const imgData = await fetch(`https://api.scryfall.com/cards/${c.oracle_card.id}`).then(r => r.json());
          return { url: imgData.image_uris.normal, name: c.name };
        })
      );

      cards.forEach((card, index) => {
        const img = document.createElement('img');
        img.src = imgUrls[index].url;
        img.title = card.name;
        img.dataset.id = card.id;  // << Add this!
        column.appendChild(img);
      });


      container.appendChild(columnDiv);
    }
  }

  // Planner functionality
  let nextUrl = `/api/decks/{{ deck_id }}/planner`;
  let loadingPlanner = false;

  document.getElementById('toggle-planner').addEventListener('click', async () => {
    const container = document.getElementById('planner-container');
    container.classList.toggle('hidden');
    if (!container.classList.contains('hidden')) {
      // load first page
      if (document.getElementById('planner-grid').children.length === 0) {
        await loadPlannerPage(nextUrl);
      }
    }
  });

  async function loadPlannerPage(url) {
    if (loadingPlanner || !url) return;
    loadingPlanner = true;

    const resp = await fetch(url);
    const data = await resp.json();

    nextUrl = data.next;
    const grid = document.getElementById('planner-grid');

    for (const card of data.results) {
      const imgData = await fetch(`https://api.scryfall.com/cards/${card.oracle_card.id}`).then(r => r.json());
      let imgUrl = imgData.image_uris ? imgData.image_uris.normal : imgData.card_faces[0].image_uris.normal;

      const img = document.createElement('img');
      img.src = imgUrl;
      img.title = card.name;
      img.className = 'w-full h-auto';
      img.dataset.id = card.id;
      grid.appendChild(img);
    }

    loadingPlanner = false;
  }

  // IntersectionObserver to trigger next page
  const sentinel = document.getElementById('scroll-sentinel');
  const observer = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) {
      loadPlannerPage(nextUrl);
    }
  });
  observer.observe(sentinel);

  loadDeck();
</script>
</body>
</html>
