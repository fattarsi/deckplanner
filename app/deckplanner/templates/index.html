<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Deck Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <!-- Subtle API link -->
  <div class="text-right mb-2">
    <a href="/api/" class="text-xs text-blue-500 hover:underline opacity-60 hover:opacity-100">API</a>
  </div>
  <!-- ðŸ“Š Card Stats Row -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
      <h2 class="text-xl font-semibold">Total Cards</h2>
      <p class="text-3xl mt-2">{{ total_cards }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <h2 class="text-xl font-semibold">Available Cards</h2>
      <p class="text-3xl mt-2">{{ available_cards }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <h2 class="text-xl font-semibold">Cards in Decks</h2>
      <p class="text-3xl mt-2">{{ cards_in_decks }}</p>
    </div>
  </div>

  <!-- ðŸ“Š Deck Stats Row -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
      <h2 class="text-xl font-semibold">Total Decks</h2>
      <p id="stat-total-decks" class="text-3xl mt-2">0</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <h2 class="text-xl font-semibold">Active Decks</h2>
      <p id="stat-active-decks" class="text-3xl mt-2">0</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <h2 class="text-xl font-semibold">Inactive Decks</h2>
      <p id="stat-inactive-decks" class="text-3xl mt-2">0</p>
    </div>
  </div>

  <!-- Deck list -->
  <div class="bg-white rounded-lg shadow p-4">
    <h2 class="text-2xl font-bold mb-4">
      Decks
      <button id="open-add-deck" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">Add deck</button> 
    </h2>
    <!-- Add Deck Modal -->
    <div id="add-deck-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
      <div class="bg-white p-6 rounded w-[500px] relative">

        <!-- Close -->
        <button class="absolute top-2 right-2 text-xl" onclick="closeAddDeckModal()">âœ•</button>

        <h2 class="text-xl font-bold mb-4">Create Deck</h2>

        <!-- Deck Name -->
        <label class="block mb-2">Deck Name</label>
        <input id="new-deck-name" class="w-full border p-2 mb-4">

        <!-- Toggle for import -->
        <button id="toggle-import" class="text-blue-500 mb-2">Import by text</button>

        <!-- Import text area -->
        <textarea id="import-textarea" class="hidden w-full border p-2 mb-4 h-24" placeholder="Paste deck list"></textarea>

        <!-- Search + card select section -->
        <div id="card-select-section" class="mb-4">
          <label class="block mb-2">Search & Add Cards</label>
          <input id="card-search-input" class="w-full border p-2" placeholder="Start typing...">

          <!-- Search results -->
          <div id="search-results" class="max-h-32 overflow-y-auto mt-2 border p-2 grid grid-cols-2 gap-2"></div>

          <!-- Selected card preview -->
          <div id="selected-cards" class="flex flex-wrap gap-2 mt-2 border p-2 min-h-[50px]"></div>
        </div>

        <!-- Submit -->
        <button id="create-deck-btn" class="bg-green-500 text-white px-3 py-2 rounded w-full mt-4">Create Deck</button>
        <button id="cancel-add-deck" class="bg-gray-500 text-white px-3 py-1 rounded mt-2">Cancel</button>

      </div>
    </div>


    <ul id="deck-list" class="space-y-2">
      <!-- JS will insert decks here -->
    </ul>
  </div>

  <script>
    function getCsrfToken() {
      return document.querySelector('meta[name="csrf-token"]').content;
    }
    function closeAddDeckModal() {
      document.getElementById('add-deck-modal').classList.add('hidden');
      document.getElementById('new-deck-name').value = '';
      document.getElementById('import-textarea').value = '';
      document.getElementById('card-search-input').value = '';
      document.getElementById('search-results').innerHTML = '';
      document.getElementById('selected-cards').innerHTML = '';
    }
    document.getElementById('open-add-deck').onclick = () => {
    document.getElementById('add-deck-modal').classList.remove('hidden');
    };
    document.getElementById('cancel-add-deck').onclick = () => {
      closeAddDeckModal();
      document.getElementById('add-deck-modal').classList.add('hidden');
    };

    const searchResults = document.getElementById('search-results');


    // Toggle behavior
    const importTextarea = document.getElementById('import-textarea');
    const cardSelectSection = document.getElementById('card-select-section');

    document.getElementById('toggle-import').onclick = () => {
      importTextarea.classList.toggle('hidden');
      cardSelectSection.classList.toggle('hidden');
    };

    const cardSearchInput = document.getElementById('card-search-input');

    let searchTimeout;
    cardSearchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(doCardSearch, 300); // debounced
    });

    let selectedCardIds = [];

    function addSelectedCard(id, imgUrl, name) {
      // Check if already selected
      const existing = document.querySelector(`#selected-cards img[data-id="${id}"]`);
      if (existing) return;

      const img = document.createElement('img');
      img.src = imgUrl;
      img.className = 'w-12 h-auto rounded';
      img.dataset.id = id;
      img.title = name;

      // Remove on click
      img.onclick = () => {
        img.remove();
        if (!document.querySelector('#selected-cards img')) {
          searchResults.innerHTML = ''; // Clear results if no cards selected
        }
      };

      document.getElementById('selected-cards').appendChild(img);
    }

    async function doCardSearch() {
      const query = cardSearchInput.value.trim();
      if (!query) {
        searchResults.innerHTML = '';
        return;
      }

      try {
        const resp = await fetch(`/api/cards/?search=${encodeURIComponent(query)}&deck__isnull=True`);
        const data = await resp.json();

        // Fetch Scryfall images in parallel
        const imgUrls = await Promise.all(
          data.results.map(async (c) => {
            const imgData = await fetch(`https://api.scryfall.com/cards/${c.oracle_card.id}`).then(r => r.json());
            return { url: imgData.image_uris.normal, name: c.name };
          })
        );

        searchResults.innerHTML = '';

        data.results.forEach((card, index) => {
          const div = document.createElement('div');
          div.className = 'flex items-center cursor-pointer p-1 hover:bg-gray-100';
          div.onclick = () => addSelectedCard(card.id, imgUrls[index].url, card.name);

          div.innerHTML = `
            <img src="${imgUrls[index].url}" class="w-12 h-auto rounded mr-2" />
            <span>${card.name}</span>
          `;
          searchResults.appendChild(div);
        });

      } catch (error) {
        console.error('Error searching cards:', error);
      }
    }



    // Submit handler
    document.getElementById('create-deck-btn').onclick = async () => {
      const name = document.getElementById('new-deck-name').value.trim();
      const deckList = importTextarea.value.trim();
      const selectedCardIds = Array.from(
        document.getElementById('selected-cards').children
      ).map(img => img.dataset.id);

      const endpoint = deckList ? '/api/deckimport/' : '/api/decks/';
      const payload = deckList ? { name, deck_list: deckList } : { name, card_ids: selectedCardIds };
      
      const resp = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
        body: JSON.stringify(payload),
      });

      if (resp.ok) {
        alert('Deck created successfully');
        closeAddDeckModal();
        location.reload();
      } else {
        const err = await resp.json();
        alert(`Error: ${JSON.stringify(err)}`);
      }
    };


    async function fetchDecks() {
      const res = await fetch('/api/decks/');
      if (!res.ok) {
        console.error('Error fetching decks');
        return;
      }
      const data = await res.json();

      // Update stats
      const total = data.count;
      const activeCount = data.results.filter(d => d.is_active).length;
      document.getElementById('stat-total-decks').textContent = total;
      document.getElementById('stat-active-decks').textContent = activeCount;
      document.getElementById('stat-inactive-decks').textContent = total - activeCount;

      // list
      const list = document.getElementById('deck-list');
      list.innerHTML = '';
      data.results.forEach(deck => {
        const li = document.createElement('li');
        li.innerHTML = `
          <a href="/decks/${deck.url.split('/').slice(-2,-1)[0]}/"
             class="block p-3 bg-gray-100 hover:bg-gray-200 rounded transition">
            <span class="font-medium">${deck.name}</span>
            <span class="text-sm text-gray-500">${deck.card_count} cards</span>
          </a>
        `;
        list.appendChild(li);
      });
    }
    fetchDecks();
  </script>
</body>
</html>

